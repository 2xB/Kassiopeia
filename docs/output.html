<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Understanding Simulation Output &mdash; Kassiopeia 3.8 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Additional Simulation Tools" href="tools.html" />
    <link rel="prev" title="Complex Shapes in KGeoBag" href="kgeobag_complex.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #343131" >
            <a href="index.html" class="icon icon-home"> Kassiopeia
            <img src="_static/KassiopeiaLogo_1_cropped_bb.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="external_documentation.html">References, Citation and Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiling.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples and Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuring Your Own Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="kgeobag_basic.html">Basic KGeoBag Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="kgeobag_complex.html">Complex KGeoBag Shapes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Understanding Simulation Output</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#output-configuration">Output configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#groups-and-fields">Groups and fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#output-structure">Output structure</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#root-output-files">ROOT output files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#data-structure">Data structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-simulation-data">Accessing simulation data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-kassiopeia">Using Kassiopeia</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-root">Using ROOT</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-python">Using Python</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-python-with-kassiopeiareader">Using Python with KassiopeiaReader</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-python-with-uproot-pandas">Using Python with uproot / Pandas</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#python-notebook">Python notebook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#geometry-visualization">Geometry visualization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#vtk-output-files">VTK output files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">Data structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Accessing simulation data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#using-paraview">Using ParaView</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ascii-output-files">ASCII output files</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Additional Simulation Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualization.html">Visualization Techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="bindings.html">XML Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #343131" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Kassiopeia</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Understanding Simulation Output</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/output.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="understanding-simulation-output">
<span id="output-label"></span><h1>Understanding Simulation Output<a class="headerlink" href="#understanding-simulation-output" title="Permalink to this heading"><span>#</span></a></h1>
<p>This section provides a description of the output files created by a <em>Kassiopeia</em> simulation, along with examples to
read and analyze the files.</p>
<nav class="contents local" id="on-this-page">
<p class="topic-title">On this page</p>
<ul class="simple">
<li><p><a class="reference internal" href="#output-configuration" id="id3">Output configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#groups-and-fields" id="id4">Groups and fields</a></p></li>
<li><p><a class="reference internal" href="#output-structure" id="id5">Output structure</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#root-output-files" id="id6">ROOT output files</a></p>
<ul>
<li><p><a class="reference internal" href="#data-structure" id="id7">Data structure</a></p></li>
<li><p><a class="reference internal" href="#accessing-simulation-data" id="id8">Accessing simulation data</a></p></li>
<li><p><a class="reference internal" href="#python-notebook" id="id9">Python notebook</a></p></li>
<li><p><a class="reference internal" href="#geometry-visualization" id="id10">Geometry visualization</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#vtk-output-files" id="id11">VTK output files</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id12">Data structure</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id13">Accessing simulation data</a></p></li>
<li><p><a class="reference internal" href="#ascii-output-files" id="id14">ASCII output files</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="output-configuration">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Output configuration</a><a class="headerlink" href="#output-configuration" title="Permalink to this heading"><span>#</span></a></h2>
<p>Generally, <em>Kassiopeia</em> output is written to <a class="reference external" href="https://root.cern.ch/">ROOT</a> output (.root) files that store simulation data at the run, event,
track and step level. In addition, if <em>Kassiopeia</em> was compiled with <a class="reference external" href="http://www.vtk.org/">VTK</a> support, output files in VTK polydata (.vtp)
format may be written. These files are mainly intended for visualization, e.g. with the <a class="reference external" href="http://www.paraview.org/">ParaView</a> software. It is
also possible to write simulation data as plaintext ASCII files, however this is not recommened for large simulations.</p>
<p>As explained in <a class="reference internal" href="configuration.html#configuration-label"><span class="std std-ref">Configuring Your Own Simulation</span></a>, the output format is configured by the available writers. Writers use the
description of the output format in the XML configuration file, which specifies the output fields that will be written
to file. Different output descriptions may be used for different writers.</p>
<section id="groups-and-fields">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Groups and fields</a><a class="headerlink" href="#groups-and-fields" title="Permalink to this heading"><span>#</span></a></h3>
<p>Structured output formats like ROOT and VTK allow to combine several output fields into a common group. This is not
only useful for analyzing the simulation results, but also allows to distinguish between data produces at the run,
event, track and step levels. An output group may be defined by the structure:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;output_step_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_id&quot;</span> <span class="na">field=</span><span class="s">&quot;step_id&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>
</pre></div>
</div>
<p>or, alternatively in the older XML syntax:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;ks_component_group</span> <span class="na">name=</span><span class="s">&quot;output_step_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_id&quot;</span> <span class="na">field=</span><span class="s">&quot;step_id&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ks_component_group&gt;</span>
</pre></div>
</div>
<p>In this case, the output file will have one group <cite>output_step_world</cite> that contains one member field <cite>step_id</cite> and is
updated at the step level, meaning that one entry will be added to the member field with each simulation step.</p>
<p>In the case above, the member field <cite>step_id</cite> refers to an attribute of the step class <cite>KSStep</cite>. Similar
fields are available in the other classes, such as <cite>KSTrack</cite>. However, in a typical simulation one also
wants to access physical attributes of the simulated particle. This is possible at the step level as well. In this case,
one may access the initial or final state of the particle in each step (where the initial state of one step equals the
final state of the preceding step, unless it is the first step in which the particle was generated). For example:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_initial_particle&quot;</span> <span class="na">field=</span><span class="s">&quot;final_particle&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_final_particle&quot;</span> <span class="na">field=</span><span class="s">&quot;final_particle&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;output_step_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_id&quot;</span> <span class="na">field=</span><span class="s">&quot;step_id&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_final_particle&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>
</pre></div>
</div>
<p>writes the initial and final particle position at each step to file. Note that in this case, one must declare a member
field <cite>step_…_particle</cite> that can be referenced inside the output group. Because the declaration is outside the group
it is not written to file, and so the output file will contain three fields at the step level. The at the track level:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;track_initial_particle&quot;</span> <span class="na">field=</span><span class="s">&quot;initial_particle&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;track_final_particle&quot;</span> <span class="na">field=</span><span class="s">&quot;final_particle&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;output_track_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;track_id&quot;</span> <span class="na">field=</span><span class="s">&quot;track_id&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;track_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;track_final_particle&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>
</pre></div>
</div>
<p>Vector data like the particle position is stored as an array of <cite>(x,y,z)</cite> components for each entry. Similarly, tensor
data is stored as an array of nine components. One may also store derived attributes like magnitude or radius:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_initial_particle&quot;</span> <span class="na">field=</span><span class="s">&quot;final_particle&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_initial_particle&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;output_step_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_radius&quot;</span> <span class="na">field=</span><span class="s">&quot;perp&quot;</span> <span class="na">parent=</span><span class="s">&quot;initial_position&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>
</pre></div>
</div>
<p>In addition to simple fields that reference internal attributes, some advanced calculation features are available:</p>
<ul class="simple">
<li><p><cite>math</cite> allows to evaluate arbitrary functions (using <a class="reference external" href="https://root.cern.ch/">ROOT</a>’s <code class="docutils literal notranslate"><span class="pre">TFormula</span></code> class) that references one or more existing
members.</p></li>
<li><p><cite>integral</cite> calculates the discrete integral of the referenced member field.</p></li>
<li><p><cite>delta</cite> calculates the difference between the current value of a member field to the previous one.</p></li>
<li><p><cite>minimum</cite> and <cite>maximum</cite> calculate the minimum/maximum value of a member field over the given interval (e.g. a track).</p></li>
<li><p><cite>minimum_at</cite> and <cite>maximum_at</cite> calculate the position of the minimum/maximum value.</p></li>
</ul>
<p>The example below shows usage of these advanced fields:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_final_particle&quot;</span> <span class="na">field=</span><span class="s">&quot;final_particle&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_kinetic_energy&quot;</span> <span class="na">field=</span><span class="s">&quot;kinetic_energy_ev&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_final_particle&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_polar_angle_to_b&quot;</span> <span class="na">field=</span><span class="s">&quot;polar_angle_to_b&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_final_particle&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;output_step_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;kinetic_energy&quot;</span> <span class="na">field=</span><span class="s">&quot;kinetic_energy_ev&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_final_particle&quot;</span><span class="nt">/&gt;</span>

    <span class="cm">&lt;!-- change in kinetic energy at each step --&gt;</span>
    <span class="nt">&lt;output_delta</span> <span class="na">name=</span><span class="s">&quot;kinetic_energy_change&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_kinetic_energy&quot;</span><span class="nt">/&gt;</span>

    <span class="cm">&lt;!-- longitudinal kinetic energy at each step, derived from kinetic energy and pitch angle --&gt;</span>
    <span class="nt">&lt;output_math</span> <span class="na">name=</span><span class="s">&quot;long_kinetic_energy&quot;</span> <span class="na">term=</span><span class="s">&quot;x0*cos(x1*TMath::Pi()/180.)*cos(x1*TMath::Pi()/180.)&quot;</span>
            <span class="na">parent=</span><span class="s">&quot;step_kinetic_energy&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_polar_angle_to_b&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>

<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_length&quot;</span> <span class="na">field=</span><span class="s">&quot;continuous_length&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;output_track_world&quot;</span><span class="nt">&gt;</span>
    <span class="cm">&lt;!-- value and position of minimum/maximum kinetic energy over each track --&gt;</span>
    <span class="nt">&lt;output_maximum</span> <span class="na">name=</span><span class="s">&quot;max_kinetic_energy&quot;</span> <span class="na">group=</span><span class="s">&quot;output_step_world&quot;</span> <span class="na">parent=</span><span class="s">&quot;kinetic_energy&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output_minimum</span> <span class="na">name=</span><span class="s">&quot;min_kinetic_energy&quot;</span> <span class="na">group=</span><span class="s">&quot;output_step_world&quot;</span> <span class="na">parent=</span><span class="s">&quot;kinetic_energy&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output_maximum_at</span> <span class="na">name=</span><span class="s">&quot;max_kinetic_energy_position&quot;</span> <span class="na">group=</span><span class="s">&quot;output_step_world&quot;</span> <span class="na">parent=</span><span class="s">&quot;kinetic_energy&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output_minimum_at</span> <span class="na">name=</span><span class="s">&quot;min_kinetic_energy_position&quot;</span> <span class="na">group=</span><span class="s">&quot;output_step_world&quot;</span> <span class="na">parent=</span><span class="s">&quot;kinetic_energy&quot;</span><span class="nt">/&gt;</span>

    <span class="cm">&lt;!-- integrated length of all steps in each track --&gt;</span>
    <span class="nt">&lt;output_integral</span> <span class="na">name=</span><span class="s">&quot;total_length&quot;</span> <span class="na">parent=</span><span class="s">&quot;step_length&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>
</pre></div>
</div>
</section>
<section id="output-structure">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Output structure</a><a class="headerlink" href="#output-structure" title="Permalink to this heading"><span>#</span></a></h3>
<p>For the remainder of this section, we will refer to the <code class="docutils literal notranslate"><span class="pre">QuadrupoleTrapSimulation.xml</span></code> example file to discuss the
output fields and their structure. Here is the (slightly shortened) output confuguration of this example:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;component_step_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;step_id&quot;</span> <span class="na">field=</span><span class="s">&quot;step_id&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;continuous_time&quot;</span> <span class="na">field=</span><span class="s">&quot;continuous_time&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;continuous_length&quot;</span> <span class="na">field=</span><span class="s">&quot;continuous_length&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;number_of_turns&quot;</span> <span class="na">field=</span><span class="s">&quot;number_of_turns&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">field=</span><span class="s">&quot;time&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;momentum&quot;</span> <span class="na">field=</span><span class="s">&quot;momentum&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;magnetic_field&quot;</span> <span class="na">field=</span><span class="s">&quot;magnetic_field&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;electric_field&quot;</span> <span class="na">field=</span><span class="s">&quot;electric_field&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;electric_potential&quot;</span> <span class="na">field=</span><span class="s">&quot;electric_potential&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;kinetic_energy&quot;</span> <span class="na">field=</span><span class="s">&quot;kinetic_energy_ev&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>

<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;component_step_cell&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;polar_angle_to_z&quot;</span> <span class="na">field=</span><span class="s">&quot;polar_angle_to_z&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;polar_angle_to_b&quot;</span> <span class="na">field=</span><span class="s">&quot;polar_angle_to_b&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;guiding_center_position&quot;</span> <span class="na">field=</span><span class="s">&quot;guiding_center_position&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;orbital_magnetic_moment&quot;</span> <span class="na">field=</span><span class="s">&quot;orbital_magnetic_moment&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_step_final_particle&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>

<span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;z_length&quot;</span> <span class="na">field=</span><span class="s">&quot;continuous_length&quot;</span> <span class="na">parent=</span><span class="s">&quot;step&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;output_group</span> <span class="na">name=</span><span class="s">&quot;component_track_world&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;creator_name&quot;</span> <span class="na">field=</span><span class="s">&quot;creator_name&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;terminator_name&quot;</span> <span class="na">field=</span><span class="s">&quot;terminator_name&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;total_steps&quot;</span> <span class="na">field=</span><span class="s">&quot;total_steps&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;number_of_turns&quot;</span> <span class="na">field=</span><span class="s">&quot;number_of_turns&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_time&quot;</span> <span class="na">field=</span><span class="s">&quot;time&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_momentum&quot;</span> <span class="na">field=</span><span class="s">&quot;momentum&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_magnetic_field&quot;</span> <span class="na">field=</span><span class="s">&quot;magnetic_field&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;initial_electric_field&quot;</span> <span class="na">field=</span><span class="s">&quot;electric_field&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_initial_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="cm">&lt;!-- ... skipped lines ... --&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_time&quot;</span> <span class="na">field=</span><span class="s">&quot;time&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_position&quot;</span> <span class="na">field=</span><span class="s">&quot;position&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_momentum&quot;</span> <span class="na">field=</span><span class="s">&quot;momentum&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_magnetic_field&quot;</span> <span class="na">field=</span><span class="s">&quot;magnetic_field&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;final_electric_field&quot;</span> <span class="na">field=</span><span class="s">&quot;electric_field&quot;</span> <span class="na">parent=</span><span class="s">&quot;component_track_final_particle&quot;</span><span class="nt">/&gt;</span>
    <span class="cm">&lt;!-- ... skipped lines ... --&gt;</span>
    <span class="nt">&lt;output</span> <span class="na">name=</span><span class="s">&quot;z_length_internal&quot;</span> <span class="na">field=</span><span class="s">&quot;continuous_length&quot;</span> <span class="na">parent=</span><span class="s">&quot;track&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;output_integral</span> <span class="na">name=</span><span class="s">&quot;z_length_integral&quot;</span> <span class="na">parent=</span><span class="s">&quot;z_length&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/output_group&gt;</span>
</pre></div>
</div>
<p>The output structure (with some fields skipped) is as follows:</p>
<div class="graphviz"><img src="_images/graphviz-b3d59b33fa3e2451ab0d345255b2b57cfc2adb44.png" alt="digraph output {
   node [fontname=&quot;helvetica&quot;, fontsize=10];
   graph [rankdir=&quot;LR&quot;] {
     rank=same
     &quot;component_step_world&quot; [shape=&quot;folder&quot;, style=filled, fillcolor=yellow];
     &quot;component_step_cell&quot; [shape=&quot;folder&quot;, style=filled, fillcolor=yellow];
     &quot;component_track_world&quot; [shape=&quot;folder&quot;, style=filled, fillcolor=yellow];
   }
   {
     rank=same
     &quot;step&quot; [shape=&quot;rectangle&quot;, style=filled, fillcolor=lightskyblue];
     &quot;track&quot; [shape=&quot;rectangle&quot;, style=filled, fillcolor=lightgreen];

     &quot;component_step_final_particle&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;component_step_position&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;component_step_length&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;component_track_initial_particle&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;component_track_final_particle&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;component_track_position&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;component_track_length&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
     &quot;z_length&quot; [shape=&quot;note&quot;, style=filled, fillcolor=whitesmoke];
   }

   &quot;component_step_world&quot; -&gt; &quot;step_id&quot; -&gt; &quot;step&quot;;
   &quot;component_step_world&quot; -&gt; &quot;continuous_time&quot; -&gt; &quot;step&quot;;
   &quot;component_step_world&quot; -&gt; &quot;continuous_length&quot; -&gt; &quot;step&quot;;
   &quot;component_step_world&quot; -&gt; &quot;number_of_turns&quot; -&gt; &quot;step&quot;;
   &quot;component_step_world&quot; -&gt; &quot;time&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_world&quot; -&gt; &quot;position&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_world&quot; -&gt; &quot;momentum&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_world&quot; -&gt; &quot;magnetic_field&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_world&quot; -&gt; &quot;electric_field&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_world&quot; -&gt; &quot;electric_potential&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_world&quot; -&gt; &quot;kinetic_energy&quot; -&gt; &quot;component_step_final_particle&quot;;

   &quot;component_step_cell&quot; -&gt; &quot;polar_angle_to_z&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_cell&quot; -&gt; &quot;polar_angle_to_b&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_cell&quot; -&gt; &quot;guiding_center_position&quot; -&gt; &quot;component_step_final_particle&quot;;
   &quot;component_step_cell&quot; -&gt; &quot;orbital_magnetic_moment&quot; -&gt; &quot;component_step_final_particle&quot;;

   &quot;component_track_world&quot; -&gt; &quot;creator_name&quot; -&gt; &quot;track&quot;;
   &quot;component_track_world&quot; -&gt; &quot;terminator_name&quot; -&gt; &quot;track&quot;;
   &quot;component_track_world&quot; -&gt; &quot;total_steps&quot; -&gt; &quot;track&quot;;
   &quot;component_track_world&quot; -&gt; &quot;number_of_turns&quot; -&gt; &quot;track&quot;;
   &quot;component_track_world&quot; -&gt; &quot;initial_time&quot; -&gt; &quot;component_track_initial_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;initial_position&quot; -&gt; &quot;component_track_initial_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;initial_momentum&quot; -&gt; &quot;component_track_initial_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;initial_magnetic_field&quot; -&gt; &quot;component_track_initial_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;initial_electric_field&quot; -&gt; &quot;component_track_initial_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;final_time&quot; -&gt; &quot;component_track_final_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;final_position&quot; -&gt; &quot;component_track_final_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;final_momentum&quot; -&gt; &quot;component_track_final_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;final_magnetic_field&quot; -&gt; &quot;component_track_final_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;final_electric_field&quot; -&gt; &quot;component_track_final_particle&quot;;
   &quot;component_track_world&quot; -&gt; &quot;z_length_internal&quot; -&gt; &quot;track&quot;;
   &quot;component_track_world&quot; -&gt; &quot;z_length_integral&quot; -&gt; &quot;z_length&quot;;

   &quot;component_step_position&quot; -&gt; &quot;step&quot; [style=dashed];
   &quot;component_step_length&quot; -&gt; &quot;step&quot; [style=dashed];
   &quot;component_step_final_particle&quot; -&gt; &quot;step&quot; [style=dashed];
   &quot;z_length&quot; -&gt; &quot;step&quot; [style=dashed];

   &quot;component_track_position&quot; -&gt; &quot;track&quot; [style=dashed];
   &quot;component_track_length&quot; -&gt; &quot;track&quot; [style=dashed];
   &quot;component_track_final_particle&quot; -&gt; &quot;track&quot; [style=dashed];
   &quot;component_track_initial_particle&quot; -&gt; &quot;track&quot; [style=dashed];
}" class="graphviz" /></div>
<p>where the relations between the output groups (left), member fields (middle), and parent objects (right) are indicated
by connecting arrows and the different node shapes. The output groups and fields are what is visible in the output file.
Member fields either refer to a particle state of a step/track, or to attributes at the step/track level directly. The
field <cite>z_length</cite> is a special case, since an intermediate field is necessary to perform the integration at track level.</p>
</section>
</section>
<section id="root-output-files">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">ROOT output files</a><a class="headerlink" href="#root-output-files" title="Permalink to this heading"><span>#</span></a></h2>
<p>The <a class="reference external" href="https://root.cern.ch/">ROOT</a> output format is the standard file format that <em>Kassiopeia</em> produces. It supports flexible configuration,
structured data fields, and efficient storage on disk. The data fields are placed in ROOT’s <code class="docutils literal notranslate"><span class="pre">TTree</span></code> and <code class="docutils literal notranslate"><span class="pre">TLeaf</span></code>
objects that are created for each output group and member field, respectively.</p>
<section id="data-structure">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Data structure</a><a class="headerlink" href="#data-structure" title="Permalink to this heading"><span>#</span></a></h3>
<p>In the output file, several tree structures are present that open into a list of leafs, corresponding to the simulation
data. Here is an example view in the <a class="reference external" href="https://root.cern.ch/">ROOT</a> <code class="docutils literal notranslate"><span class="pre">TBrowser</span></code>:</p>
<a class="reference internal image-reference" href="_images/root_output.png"><img alt="_images/root_output.png" src="_images/root_output.png" style="width: 350pt;" /></a>
<p>According to the configuration in <code class="docutils literal notranslate"><span class="pre">QuadrupoleTrapSimulation.xml</span></code>, three output groups have been created:
<cite>component_track_world</cite>, <cite>component_step_world</cite>, and <cite>component_step_cell</cite>. Each of these is split into several tree
in the ROOT file, distinguished by their postfix:</p>
<ul class="simple">
<li><p><cite>…_DATA</cite> contains the actual simulation data. For each output field, one leaf object (an array-like structure) is
created in the output file. In the example shown here, the <cite>component_step_world_DATA</cite> tree contains the fields
<cite>step_id</cite>, <cite>time</cite> and so on. In case of vector or tensor data, one individual field is created for each component,
e.g. <cite>position_x</cite>, <cite>position_y</cite>, <cite>position_z</cite>. All output fields are sorted by the respective index, e.g. step data
is sorted by <cite>STEP_INDEX</cite> (which is a continually increasing integer number). This allows direct access to any
specific data field at any output level. Note that the step index can be different than the <cite>step id</cite>, which is an
attribute of the <cite>KSStep</cite> class and thus defined by the simulation.</p></li>
<li><p><cite>…_PRESENCE</cite> indicates which segments in the data array contain valid data. This tree contains the fields <cite>INDEX</cite>,
referring to the start index in the output data, and <cite>LENGTH</cite>, referring to the length of one segment. When reading
values from the data arrays, these fields should be checked so that only valid data is used.</p></li>
<li><p><cite>…_STRUCTURE</cite> contains the fields <cite>LABEL</cite> and <cite>TYPE</cite>. For each output field present in the file, they indicate its
name (i.e. the name of the leaf placed under <cite>…_DATA</cite>) and its type (<code class="docutils literal notranslate"><span class="pre">double</span></code> etc.). When reading the data arrays,
this information can be taken into account in order to treat data types correctly.</p></li>
</ul>
<p>Note that the data in each leaf is written continuously, i.e. there is no distinction between individual tracks, events,
or runs. This is done in order to improve storage efficiency and to provide a clean output structure. Hence, the step
index is a monotonic integer number that increases with each new value written to the output file. In order to
distinguish between different tracks, one needs to know the step indices corresponding to the start and end of the
track so that the corresponding data segment can be analyzed. This is possible with the following meta-data fields.</p>
<p>In addition to the output groups defined in the XML configuration file, several trees containing meta-data are present
in the output file. This data is always present in the <a class="reference external" href="https://root.cern.ch/">ROOT</a> file, regardless of the output configuration:</p>
<ul class="simple">
<li><p><cite>RUN_KEYS</cite>, <cite>EVENT_KEYS</cite>, etc. contain the names of the output groups present in the file. In the example shown here,
the <cite>TRACK_KEYS</cite> tree contains one element <cite>component_track_world</cite>, while <cite>STEP_KEYS</cite> contains two elements.</p></li>
<li><p><cite>RUN_DATA</cite>, <cite>EVENT_DATA</cite>, etc. each contain a list of run/event/… indices that correspond to the internally used
indices for accessing data at the corresponding level. For example, <cite>STEP_DATA</cite> contains a field <cite>STEP_INDEX</cite>,
which holds all indices that can be accessed in the data arrays.  In addition, the <cite>…_DATA</cite> trees at higher levels
than step also provide a mapping between to the indices at the lower levels:</p>
<ul>
<li><p><cite>TRACK_DATA</cite> contains the arrays <cite>FIRST_STEP_INDEX</cite> and <cite>LAST_STEP_INDEX</cite>. For each track that is designated by
<cite>TRACK_INDEX</cite> they point to the index of the first and last step of the track. Hence if one looks at the step
output, <cite>component_step_world</cite> in this case, one may use these step indices to split the step data into individual
track segments. Similarly,</p></li>
<li><p><cite>EVENT_DATA</cite> contains the fields <cite>(FIRST|LAST)_STEP_INDEX</cite> and <cite>(FIRST|LAST)_TRACK_INDEX</cite>, and</p></li>
<li><p><cite>RUN_DATA</cite> contains  <cite>(FIRST|LAST)_STEP_INDEX</cite>, <cite>(FIRST|LAST)_TRACK_INDEX</cite>, and <cite>(FIRST|LAST)_EVENT_INDEX</cite>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="accessing-simulation-data">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Accessing simulation data</a><a class="headerlink" href="#accessing-simulation-data" title="Permalink to this heading"><span>#</span></a></h3>
<p>In most cases, for example when using the <a class="reference external" href="https://root.cern.ch/">ROOT</a> <code class="docutils literal notranslate"><span class="pre">TBrowser</span></code>, one may just look into the <cite>STEP_DATA</cite> and <cite>TRACK_DATA</cite>
fields to find the relevant information. For more sophisticated analyses, other means of accessing the data are
available.</p>
<section id="using-kassiopeia">
<h4>Using Kassiopeia<a class="headerlink" href="#using-kassiopeia" title="Permalink to this heading"><span>#</span></a></h4>
<p><em>Kassiopeia</em> includes a simple analysis application that uses the <cite>KSReadFileROOT</cite> class to iterate through
the step output produced by the <cite>QuadrupoleTrapSimulation.xml</cite> example. Its code is available at
<a class="reference external" href="https://github.com/KATRIN-Experiment/Kassiopeia/blob/master/Kassiopeia/Applications/Examples/Source/QuadrupoleTrapAnalysis.cxx">GitHub: Kassiopeia/Applications/Examples/Source/QuadrupoleTrapAnalysis.cxx</a> and it serves as a general example
of using this method.</p>
<p>In this case, the simulation output can be accessed in a structured way, using the run/event/track/step levels and
iterating through each component:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tRunReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">tRunReader</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tRunReader</span><span class="p">.</span><span class="n">GetLastRunIndex</span><span class="p">();</span><span class="w"> </span><span class="n">tRunReader</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// run analysis code</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tEventReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tRunReader</span><span class="p">.</span><span class="n">GetFirstEventIndex</span><span class="p">();</span><span class="w"> </span><span class="n">tEventReader</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tRunReader</span><span class="p">.</span><span class="n">GetLastEventIndex</span><span class="p">();</span><span class="w"> </span><span class="n">tEventReader</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// event analysis code</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tTrackReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tEventReader</span><span class="p">.</span><span class="n">GetFirstTrackIndex</span><span class="p">();</span><span class="w"> </span><span class="n">tTrackReader</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tEventReader</span><span class="p">.</span><span class="n">GetLastTrackIndex</span><span class="p">();</span><span class="w"> </span><span class="n">tTrackReader</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// track analysis code</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">tStepReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tTrackReader</span><span class="p">.</span><span class="n">GetFirstStepIndex</span><span class="p">();</span><span class="w"> </span><span class="n">tStepReader</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tTrackReader</span><span class="p">.</span><span class="n">GetLastStepIndex</span><span class="p">();</span><span class="w">  </span><span class="n">tStepReader</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// step analysis code</span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Individual output fields are accessed via an instance of <cite>KSReadObjectROOT</cite>, as shown in the example. The
benefit of using this method is that it uses <em>Kassiopeia’s</em> internal classes that are fully compatible with the writer
class that produced the output file. On the other hand, it requires writing a custom C++ application that needs
to be compiled against <em>Kasper</em>.</p>
</section>
<section id="using-root">
<h4>Using ROOT<a class="headerlink" href="#using-root" title="Permalink to this heading"><span>#</span></a></h4>
<p>Alternatively, the output can be access directly from a <a class="reference external" href="https://root.cern.ch/">ROOT</a> program. In this case, the ouput is accessible through
the <cite>TTreeReader</cite> interface:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">TFile</span><span class="w"> </span><span class="nf">file</span><span class="p">(</span><span class="s">&quot;QuadrupoleTrapSimulation.root&quot;</span><span class="p">);</span><span class="w"></span>

<span class="n">TTreeReader</span><span class="w"> </span><span class="nf">track_data</span><span class="p">(</span><span class="s">&quot;TRACK_DATA&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="n">TTreeReaderValue</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="w"> </span><span class="n">first_step_index</span><span class="p">(</span><span class="n">track_data</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;FIRST_STEP_INDEX&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">TTreeReaderValue</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="w"> </span><span class="n">last_step_index</span><span class="p">(</span><span class="n">track_data</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LAST_STEP_INDEX&quot;</span><span class="p">);</span><span class="w"></span>

<span class="n">TTreeReader</span><span class="w"> </span><span class="nf">step_data</span><span class="p">(</span><span class="s">&quot;component_step_cell_DATA&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="n">TTreeReaderValue</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">step_moment</span><span class="p">(</span><span class="n">step_data</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;orbital_magnetic_moment&quot;</span><span class="p">);</span><span class="w"></span>

<span class="n">TTreeReader</span><span class="w"> </span><span class="nf">step_presence</span><span class="p">(</span><span class="s">&quot;component_step_cell_PRESENCE&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="n">TTreeReaderValue</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="w"> </span><span class="n">valid_index</span><span class="p">(</span><span class="n">step_presence</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;INDEX&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">TTreeReaderValue</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="w"> </span><span class="n">valid_length</span><span class="p">(</span><span class="n">step_presence</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LENGTH&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>As explained further below, here it is necessary to take into account the information from the <code class="docutils literal notranslate"><span class="pre">TRACK_DATA</span></code> tree to
get the first and last step index belonging to each track, as well as the <code class="docutils literal notranslate"><span class="pre">..._PRESENCE</span></code> tree to only work on valid
entries in the output group. Because the simulation only fills the <code class="docutils literal notranslate"><span class="pre">component_step_cell</span></code> output in a certain region
of the geometry (the inner part of the trap), some values outside this region contain invalid values.</p>
<p>One approach to handle this structure is shown below, where the main loop iterates over each track and the inner loop
over the steps only processes valid output fields:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">vector</span><span class="o">&lt;</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="p">,</span><span class="kt">unsigned</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">valid_steps</span><span class="p">;</span><span class="w"></span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">step_presence</span><span class="p">.</span><span class="n">Next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">valid_steps</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="o">*</span><span class="n">valid_index</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">valid_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">*</span><span class="n">valid_length</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">track_data</span><span class="p">.</span><span class="n">Next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">max_moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">TMath</span><span class="o">::</span><span class="n">Infinity</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">min_moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TMath</span><span class="o">::</span><span class="n">Infinity</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">step_data</span><span class="p">.</span><span class="n">Next</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step_data</span><span class="p">.</span><span class="n">GetCurrentEntry</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">*</span><span class="n">first_step_index</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">last_step_index</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">valid_steps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">valid</span><span class="p">.</span><span class="n">first</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">valid</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">step_moment</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_moment</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">max_moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">step_moment</span><span class="p">;</span><span class="w"></span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">step_moment</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_moment</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">min_moment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">step_moment</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">max_moment</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">min_moment</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">max_moment</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">min_moment</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;extrema for track &lt;&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">deviation</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;&gt;&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="using-python">
<h4>Using Python<a class="headerlink" href="#using-python" title="Permalink to this heading"><span>#</span></a></h4>
<p>Another common method of analysis makes use of Python libraries such as <a class="reference external" href="https://numpy.org/">NumPy</a> and <a class="reference external" href="https://pandas.pydata.org/">Pandas</a>. Several methods of getting
the <em>Kassiopeia</em> output into a Python script are available:</p>
<ul class="simple">
<li><p><cite>KassiopeiaReader</cite> is a Python module based on <em>PyROOT</em> (the official Python-interface of the <a class="reference external" href="https://root.cern.ch/">ROOT</a> software). It is
essentially a wrapper around ROOT classes that takes into account the relations between <em>Kassiopeia’s</em> output levels
and allows easy iteration over step/track/… data fields. Its code is available at
<a class="reference external" href="https://github.com/KATRIN-Experiment/Kassiopeia/blob/master/Kassiopeia/Python/KassiopeiaReader.py">GitHub: Kassiopeia/Python/KassiopeiaReader.py</a>.</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/uproot/">uproot</a> is a ROOT-less implementation of the <a class="reference external" href="https://root.cern.ch/">ROOT</a> file interface. It allows to access <em>Kassiopeia’s</em> output data
without the ROOT dependency. Especially for large output files, this is a very efficient way of processing the
simulation results. However, it is difficult to take into account relations between the output levels; e.g. in order
to select specific steps that belong to a track or event in the simulation.</p></li>
<li><p><a class="reference external" href="https://pandas.pydata.org/">Pandas</a> can be used together with uproot (or PyROOT) to access <em>Kassiopeia’s</em> output data in the form of a Pandas
dataframe. With some extra work, it is possible to include the relations between output levels as well.</p></li>
</ul>
<p>All three methods will be briefly explained in this section, in the form of a simple example that reproduces the
<cite>QuadrupoleTrapAnalysis.cxx</cite> code introduced above. The examples use the <a class="reference external" href="https://root.cern.ch/">ROOT</a> file <code class="docutils literal notranslate"><span class="pre">QuadrupoleTrapSimulation.root</span></code>
produced by the <code class="docutils literal notranslate"><span class="pre">QuadrupoleTrapSimulation.xml</span></code> example.</p>
</section>
<section id="using-python-with-kassiopeiareader">
<h4>Using Python with KassiopeiaReader<a class="headerlink" href="#using-python-with-kassiopeiareader" title="Permalink to this heading"><span>#</span></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">KassiopeiaReader</span></code> Python module provides an iterator interface to a selected output group in a <em>Kassiopeia</em>
file. It can easily be used to retrieve e.g. all track or step output from a simulation. Correctly iterating over
more advanced output definitions take more effort, however. The <cite>QuadrupoleTrapSimulation</cite> is a good example for this,
because it uses an additional output region (<code class="docutils literal notranslate"><span class="pre">component_step_cell</span></code>) that is only filled with data in a small section
of each particle’s trajectory.</p>
<p>To re-implement the <cite>QuadrupoleTrapAnalysis.cxx</cite> program, a few things need to be considered that are explained below.
The full example script is located at <a class="reference external" href="https://github.com/KATRIN-Experiment/Kassiopeia/blob/master/Kassiopeia/Python/Examples/QuadrupoleTrapAnalysis.py">GitHub: Kassiopeia/Python/Examples/QuadrupoleTrapAnalysis.py</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">KassiopeiaReader</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">KassiopeiaReader</span><span class="o">.</span><span class="n">Iterator</span><span class="p">(</span><span class="s1">&#39;QuadrupoleTrapSimulation.root&#39;</span><span class="p">)</span>

<span class="n">reader</span><span class="o">.</span><span class="n">loadTree</span><span class="p">(</span><span class="s1">&#39;component_step_cell&#39;</span><span class="p">)</span>
<span class="n">reader</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;orbital_magnetic_moment&#39;</span><span class="p">)</span>

<span class="n">track_step_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">reader</span><span class="o">.</span><span class="n">getTracks</span><span class="p">(</span><span class="s1">&#39;FIRST_STEP_INDEX&#39;</span><span class="p">),</span> <span class="n">reader</span><span class="o">.</span><span class="n">getTracks</span><span class="p">(</span><span class="s1">&#39;LAST_STEP_INDEX&#39;</span><span class="p">)]))</span>

<span class="n">step_presence</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">getTree</span><span class="p">(</span><span class="s1">&#39;component_step_cell_PRESENCE&#39;</span><span class="p">)</span>
<span class="n">step_valid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">step_presence</span><span class="p">[</span><span class="s1">&#39;INDEX&#39;</span><span class="p">],</span> <span class="n">step_presence</span><span class="p">[</span><span class="s1">&#39;LENGTH&#39;</span><span class="p">]]))</span>
</pre></div>
</div>
<p>First of all, we need to import the Python module and create an instance for reading the output file
<code class="docutils literal notranslate"><span class="pre">QuadrupoleTrapSimulation.root</span></code>. The data we’re interested in is located in the <code class="docutils literal notranslate"><span class="pre">component_step_cell</span></code> tree.
As we will see later, the <code class="docutils literal notranslate"><span class="pre">component_step_cell_PRESENCE</span></code> tree is important in this example because it defines the
step entries that contain valid data (i.e. where the output was filled by the simulation, according to the definition
in the configuration file.) Because we’re only interested in a single output field <code class="docutils literal notranslate"><span class="pre">orbital_magnetic_moment</span></code>, we
can select it before accessing any data in order to reduce memory footprint.</p>
<p>Our analysis requires to compute the magnetic moment deviation for each single track. This requires to consider the
relation between step and track data. One method which is used here is to use the <code class="docutils literal notranslate"><span class="pre">(FIRST|LAST)_STEP_INDEX</span></code> field of
the track structure to select the first and last step index which belongs to a given track. However, because
not all of these steps will contain data in this case, some further adjustment is required: We also check the contents
of the <code class="docutils literal notranslate"><span class="pre">component_step_cell_PRESENCE</span></code> tree from above, and see if the first step index needs to be moved ahead to
the first valid data point. Similarly, we check if the last step index needs to be moved back.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">first_step_index</span><span class="p">,</span> <span class="n">last_step_index</span> <span class="ow">in</span> <span class="n">track_step_index</span><span class="p">:</span>

    <span class="n">max_moment</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">min_moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
        <span class="n">step_index</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">iev</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">step_index</span> <span class="o">&lt;</span> <span class="n">first_step_index</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">first_valid</span><span class="p">,</span><span class="n">valid_length</span> <span class="ow">in</span> <span class="n">step_valid</span><span class="p">:</span>

            <span class="n">last_valid</span> <span class="o">=</span> <span class="n">first_valid</span> <span class="o">+</span> <span class="n">valid_length</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">step_index</span> <span class="o">&gt;=</span> <span class="n">first_valid</span> <span class="ow">and</span> <span class="n">step_index</span> <span class="o">&lt;=</span> <span class="n">last_valid</span><span class="p">:</span>

                <span class="n">moment</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">orbital_magnetic_moment</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">moment</span> <span class="o">&gt;</span> <span class="n">max_moment</span><span class="p">:</span>
                    <span class="n">max_moment</span> <span class="o">=</span> <span class="n">moment</span>
                <span class="k">if</span> <span class="n">moment</span> <span class="o">&lt;</span> <span class="n">min_moment</span><span class="p">:</span>
                    <span class="n">min_moment</span> <span class="o">=</span> <span class="n">moment</span>

            <span class="k">if</span> <span class="n">first_valid</span> <span class="o">&gt;</span> <span class="n">first_step_index</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">step_index</span> <span class="o">&gt;=</span> <span class="n">last_step_index</span><span class="p">:</span>
             <span class="k">break</span>

    <span class="n">deviation</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_moment</span> <span class="o">-</span> <span class="n">min_moment</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_moment</span> <span class="o">+</span> <span class="n">min_moment</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extrema for track &lt;</span><span class="si">{:g}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deviation</span><span class="p">))</span>
</pre></div>
</div>
<p>With this information, the step iterator can be advanced to the first step before starting the data processing. It is
then very straightforward to iterate over the range of steps beloging to the current track by advancing the step
iterator accordingly. In this example we retrieve the value <code class="docutils literal notranslate"><span class="pre">orbital_magnetic_moment</span></code> for each step, determine
its minimum/maximum over the entire track, and then calculate and print a mean deviation.</p>
<p>All output values should be in agreement with the C++ program.</p>
</section>
<section id="using-python-with-uproot-pandas">
<h4>Using Python with uproot / Pandas<a class="headerlink" href="#using-python-with-uproot-pandas" title="Permalink to this heading"><span>#</span></a></h4>
<p>The same result can be achieved by using the <a class="reference external" href="https://pypi.org/project/uproot/">uproot</a> package with <a class="reference external" href="https://pandas.pydata.org/">Pandas</a> dataframes. In this case, PyROOT isn’t needed
and the analysis can run without <a class="reference external" href="https://root.cern.ch/">ROOT</a> dependencies. Applying the knowledge about <em>Kassiopeia’s</em> output structure
that we gathered in the section above, we can write the following snippet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">uproot</span>
<span class="c1">#import uproot3 as uproot  # try this if newer uproot does not work</span>

<span class="c1"># Open data file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;QuadrupoleTrapSimulation.root&#39;</span><span class="p">)</span>

<span class="c1"># Read data structures</span>
<span class="n">df0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;TRACK_DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_step_cell_DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df1p</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_step_cell_PRESENCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>

<span class="c1"># Extend step data for merging</span>
<span class="n">df1</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Iterate over tracks and assign to step data</span>
<span class="k">for</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">first_step_index</span><span class="p">,</span> <span class="n">last_step_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df0</span><span class="p">[</span><span class="s1">&#39;TRACK_INDEX&#39;</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;FIRST_STEP_INDEX&#39;</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;LAST_STEP_INDEX&#39;</span><span class="p">]):</span>

    <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">first_valid</span><span class="p">,</span> <span class="n">valid_length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df1p</span><span class="p">[</span><span class="s1">&#39;INDEX&#39;</span><span class="p">],</span> <span class="n">df1p</span><span class="p">[</span><span class="s1">&#39;LENGTH&#39;</span><span class="p">]):</span>
        <span class="n">last_valid</span> <span class="o">=</span> <span class="n">first_valid</span> <span class="o">+</span> <span class="n">valid_length</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">first_valid</span> <span class="o">&gt;=</span> <span class="n">first_step_index</span> <span class="ow">and</span> <span class="n">last_valid</span> <span class="o">&lt;=</span> <span class="n">last_step_index</span><span class="p">:</span>
            <span class="n">df1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">start_index</span><span class="o">+</span><span class="n">valid_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;track_id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">track_id</span>

        <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="n">last_step_index</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">start_index</span> <span class="o">+=</span> <span class="n">valid_length</span>

    <span class="c1"># Select data of current track</span>
    <span class="n">steps_moment</span> <span class="o">=</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1</span><span class="o">.</span><span class="n">track_id</span> <span class="o">==</span> <span class="n">track_id</span><span class="p">][</span><span class="s1">&#39;orbital_magnetic_moment&#39;</span><span class="p">]</span>
    <span class="n">max_moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">steps_moment</span><span class="p">)</span>
    <span class="n">min_moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">steps_moment</span><span class="p">)</span>

    <span class="c1"># Compute result</span>
    <span class="n">deviation</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_moment</span> <span class="o">-</span> <span class="n">min_moment</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_moment</span> <span class="o">+</span> <span class="n">min_moment</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extrema for track #</span><span class="si">{:d}</span><span class="s2"> &lt;</span><span class="si">{:g}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">track_id</span><span class="p">,</span> <span class="n">deviation</span><span class="p">))</span>
</pre></div>
</div>
<p>Here the output file is opened with <code class="docutils literal notranslate"><span class="pre">uproot.open()</span></code> and the relevant data trees are accessed via the <code class="docutils literal notranslate"><span class="pre">pandas.df()</span></code>
interface. This is a pretty efficient way of accessing and iterating over the output fields. For our analysis, we loop
over the tracks in the <code class="docutils literal notranslate"><span class="pre">TRACK_DATA</span></code> tree, select the valid step range (with the same caveat noted above), and simply
use <a class="reference external" href="https://numpy.org/">NumPy</a>’s methods to determine the minimum/maximum of the magnetic moment.</p>
<p>Obviously this code is more compact than the <em>KassiopeiaReader</em> method from above. For large output files with many
steps, it is also much faster. The main convenience arises from using dataframes to represent the data, which allows
slicing of data segments, instead of using a step-by-step iterative approach.</p>
<p>The example above could be easily extended to allow multiple valid segments per track (using the <cite>PRESENCE</cite> tree) and
for other relations between runs, events, tracks, and steps. Consider for example a simulation where secondary particles
are produced over the course of a track, which need to be mapped to the primary event.</p>
<p>There is another method of producing the track-by-track result that is printed by the code above. Instead of computing
the results in the main loop, one may use the <code class="docutils literal notranslate"><span class="pre">DataFrame.groupby()</span></code> method to iterate over tracks in a second loop.
This is a more useful approach in case of more complex analysis:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate over tracks and assign to step data</span>
<span class="c1"># ... see above ...</span>

<span class="k">for</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df1</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;track_id&quot;</span><span class="p">):</span>
    <span class="n">steps_moment</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">orbital_magnetic_moment</span>

    <span class="n">max_moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">steps_moment</span><span class="p">)</span>
    <span class="n">min_moment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">steps_moment</span><span class="p">)</span>

    <span class="n">deviation</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_moment</span> <span class="o">-</span> <span class="n">min_moment</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_moment</span> <span class="o">+</span> <span class="n">min_moment</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extrema for track #</span><span class="si">{:d}</span><span class="s2"> &lt;</span><span class="si">{:g}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track_id</span><span class="p">),</span> <span class="n">deviation</span><span class="p">))</span>
</pre></div>
</div>
<p>The use of <a class="reference external" href="https://pandas.pydata.org/">Pandas</a> dataframes makes it fairly easy to select and combine data as needed. Consider again the
<code class="docutils literal notranslate"><span class="pre">QuadrupoleTrapSimulation.xml</span></code> example, where the step output is split into a <cite>world</cite> and <cite>cell</cite> group. One may need
to merge the two datasets before the analysis, e.g. if one needs to relate the magnetic moment to the magnetic field.
The code below shows how this can be done with <code class="docutils literal notranslate"><span class="pre">DataFrame.concat()</span></code> and <code class="docutils literal notranslate"><span class="pre">DataFrame.merge()</span></code> methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">uproot</span>
<span class="c1">#import uproot3 as uproot  # try this if newer uproot does not work</span>

<span class="c1"># Open data file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">uproot</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;QuadrupoleTrapSimulation.root&#39;</span><span class="p">)</span>

<span class="c1"># Read data structures</span>
<span class="n">df0</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;TRACK_DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_track_world_DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_step_world_DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_step_cell_DATA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df2p</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_step_world_PRESENCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
<span class="n">df3p</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;component_step_cell_PRESENCE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pandas</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>

<span class="c1"># Extend step data for merging</span>
<span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">df0</span><span class="p">[</span><span class="s1">&#39;TRACK_INDEX&#39;</span><span class="p">])</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df3</span> <span class="o">=</span> <span class="n">df3</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Iterate over tracks and assign to step data</span>
<span class="k">for</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">first_step_index</span><span class="p">,</span> <span class="n">last_step_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df0</span><span class="p">[</span><span class="s1">&#39;TRACK_INDEX&#39;</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;FIRST_STEP_INDEX&#39;</span><span class="p">],</span> <span class="n">df0</span><span class="p">[</span><span class="s1">&#39;LAST_STEP_INDEX&#39;</span><span class="p">]):</span>

    <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">first_valid</span><span class="p">,</span> <span class="n">valid_length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df2p</span><span class="p">[</span><span class="s1">&#39;INDEX&#39;</span><span class="p">],</span> <span class="n">df2p</span><span class="p">[</span><span class="s1">&#39;LENGTH&#39;</span><span class="p">]):</span>
        <span class="n">last_valid</span> <span class="o">=</span> <span class="n">first_valid</span> <span class="o">+</span> <span class="n">valid_length</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">first_valid</span> <span class="o">&gt;=</span> <span class="n">first_step_index</span> <span class="ow">and</span> <span class="n">last_valid</span> <span class="o">&lt;=</span> <span class="n">last_step_index</span><span class="p">:</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">start_index</span><span class="o">+</span><span class="n">valid_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;track_id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">track_id</span>
            <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">start_index</span><span class="o">+</span><span class="n">valid_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;step_id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">first_valid</span><span class="p">,</span> <span class="n">last_valid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="n">last_step_index</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">start_index</span> <span class="o">+=</span> <span class="n">valid_length</span>

    <span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">first_valid</span><span class="p">,</span> <span class="n">valid_length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df3p</span><span class="p">[</span><span class="s1">&#39;INDEX&#39;</span><span class="p">],</span> <span class="n">df3p</span><span class="p">[</span><span class="s1">&#39;LENGTH&#39;</span><span class="p">]):</span>
        <span class="n">last_valid</span> <span class="o">=</span> <span class="n">first_valid</span> <span class="o">+</span> <span class="n">valid_length</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">first_valid</span> <span class="o">&gt;=</span> <span class="n">first_step_index</span> <span class="ow">and</span> <span class="n">last_valid</span> <span class="o">&lt;=</span> <span class="n">last_step_index</span><span class="p">:</span>
            <span class="n">df3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">start_index</span><span class="o">+</span><span class="n">valid_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;track_id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">track_id</span>
            <span class="n">df3</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">start_index</span><span class="o">+</span><span class="n">valid_length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;step_id&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">first_valid</span><span class="p">,</span> <span class="n">last_valid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_index</span> <span class="o">&gt;</span> <span class="n">last_step_index</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">start_index</span> <span class="o">+=</span> <span class="n">valid_length</span>

<span class="c1"># Assign indices for merging</span>
<span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;track_id&#39;</span><span class="p">)</span>
<span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;step_id&#39;</span><span class="p">)</span>
<span class="n">df3</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;step_id&#39;</span><span class="p">)</span>

<span class="c1"># Merge the step data frames (append columns)</span>
<span class="c1">#   `inner` join: keep only steps that exist in *both* data frames</span>
<span class="c1">#   `outer` join: keep all steps, even those that only exist in one data frame</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df2</span><span class="p">,</span> <span class="n">df3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>

<span class="c1"># Merge the track data frame (merge columns via common `track_id`)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;track_id&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;track_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;track_id&#39;</span><span class="p">,</span> <span class="s1">&#39;step_id&#39;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">track_id</span><span class="p">,</span><span class="n">group</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;track_id&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;track #</span><span class="si">{:d}</span><span class="s2">:</span><span class="se">\t</span><span class="s2"> max. magnetic field is &lt;</span><span class="si">{:g}</span><span class="s2">&gt; and mean magnetic moment is &lt;</span><span class="si">{:g}</span><span class="s2">&gt;&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">track_id</span><span class="p">),</span> <span class="n">group</span><span class="o">.</span><span class="n">magnetic_field_z</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">group</span><span class="o">.</span><span class="n">orbital_magnetic_moment</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
<p>Keep in mind that while this approach is pretty flexible, it easily consumes a lot of memory because of the combination
of large data frames. This is especially true when the output fields contain a large number of elements. In that case,
it is advisable to select only the necessary fields before the merge steps.</p>
</section>
</section>
<section id="python-notebook">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Python notebook</a><a class="headerlink" href="#python-notebook" title="Permalink to this heading"><span>#</span></a></h3>
<p>A complete analysis using Pandas dataframes for the <cite>QuadrupoleTrapSimulation.xml</cite> example is available in the form of a Python notebook: <a class="reference external" href="https://github.com/KATRIN-Experiment/Kassiopeia/blob/main/Kassiopeia/AnalysisExamples/QuadrupoleTrapAnalysis.ipynb">QuadrupoleTrapAnalysis.ipynb</a></p>
</section>
<section id="geometry-visualization">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Geometry visualization</a><a class="headerlink" href="#geometry-visualization" title="Permalink to this heading"><span>#</span></a></h3>
<p>It is often useful to combine a view of the simulation geometry with a plot of the step data. In Python this can be done with the help of <a class="reference external" href="http://www.vtk.org/">VTK</a> files created by <em>KGeoBag</em>. For more details, see <a class="reference internal" href="visualization.html#visualization-label"><span class="std std-ref">Visualization Techniques</span></a>.</p>
</section>
</section>
<section id="vtk-output-files">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">VTK output files</a><a class="headerlink" href="#vtk-output-files" title="Permalink to this heading"><span>#</span></a></h2>
<p>The <a class="reference external" href="http://www.vtk.org/">VTK</a> output format can be used in addition to the standard format and is mainly intended for visualization purposes.
The most flexible way to visualize simulation output is by using the <a class="reference external" href="http://www.paraview.org/">ParaView</a> software, which can import the output
files created by <em>Kassiopeia</em>. The VTK format supports flexible configuration and can be set up independently of the
ROOT output. The VTK writer creates indepdendent files at the track and step level, which typically hold the position
as the main data field (required for 3D visualization), and any number of additional data fields.</p>
<section id="id1">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Data structure</a><a class="headerlink" href="#id1" title="Permalink to this heading"><span>#</span></a></h3>
<p>In the output file, several tree structures are present that open into a list of leafs, corresponding to the simulation
data. Here is an example view in <a class="reference external" href="http://www.paraview.org/">ParaView</a>:</p>
<a class="reference internal image-reference" href="_images/paraview_sheet.png"><img alt="_images/paraview_sheet.png" src="_images/paraview_sheet.png" style="width: 500pt;" /></a>
<p>In this example, the step and track output only contains one data field in addition to the particle position. For the
step output, the file contains the fields of <cite>component_step_world</cite> and the position at each point. Each point
corresponds to one step in the simulation. As with the ROOT output, the step data itself is continuous and not split
into individual tracks. However, because the 3D representation of the steps is stored as a <code class="docutils literal notranslate"><span class="pre">vtkPolyLine</span></code>, the
visualization can dinstignuish between individual tracks: Each track in the simulation corresponds to a polyline in the
VTK step file.</p>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Accessing simulation data</a><a class="headerlink" href="#id2" title="Permalink to this heading"><span>#</span></a></h3>
<p>Because the <a class="reference external" href="http://www.vtk.org/">VTK</a> output is mainly intended for visualization, we will only cover the use of the standard software
<a class="reference external" href="http://www.paraview.org/">ParaView</a> in this guide. In principle, VTK data files can also be used to store and access simulation output (and e.g.
read their contents using Python), but this approach is less flexible than with <a class="reference external" href="https://root.cern.ch/">ROOT</a> output and not advised.</p>
<section id="using-paraview">
<h4>Using ParaView<a class="headerlink" href="#using-paraview" title="Permalink to this heading"><span>#</span></a></h4>
<p>ParaView offers a quite sophisticated interface for various kinds of visualization. With the output files generated
by the quadrupole trap simulation, one may reproduce the following image by loading the VTK step file
(<code class="docutils literal notranslate"><span class="pre">output/Kassiopeia/QuadrupoleTrapSimulationStep.vtp</span></code>) and the geometry file created by the <cite>geometry_painter</cite> after
the simulation (<code class="docutils literal notranslate"><span class="pre">output/TheBag/geometry_painter.vtp</span></code>):</p>
<a class="reference internal image-reference" href="_images/paraview_render.png"><img alt="_images/paraview_render.png" src="_images/paraview_render.png" style="width: 500pt;" /></a>
<p>The geometry is shown as colored surfaces according to the configuration in the XML file; the colors are defined by the
<code class="docutils literal notranslate"><span class="pre">&lt;appearance</span> <span class="pre">.../&gt;</span></code> elements. To make the tracks visible, the <em>Slice</em> operation was applied which cuts away one side
of the close surfaces, and the opacity was recuced to 50%. The individual steps are shown as points and colored by
their electric potential.</p>
<p>ParaView allows to change the data represenation by choosing different color maps and normalization, applying cuts and
other data operations, and combining multiple source files. In addition to 2D and 3D render views, the user can also
investigate the underlying data with typical plotting tools like shown here:</p>
<a class="reference internal image-reference" href="_images/paraview_histogram.png"><img alt="_images/paraview_histogram.png" src="_images/paraview_histogram.png" style="width: 500pt;" /></a>
<p>For a full documentation, see:</p>
<blockquote>
<div><p><a class="reference external" href="https://www.paraview.org/Wiki/The_ParaView_Tutorial">https://www.paraview.org/Wiki/The_ParaView_Tutorial</a></p>
<p><a class="reference external" href="https://docs.paraview.org/en/latest/">https://docs.paraview.org/en/latest/</a></p>
</div></blockquote>
</section>
</section>
<section id="ascii-output-files">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">ASCII output files</a><a class="headerlink" href="#ascii-output-files" title="Permalink to this heading"><span>#</span></a></h3>
<p>The ASCII output writer creates a simple, space-separated file that contains all the output values defined in the
configuration file. Each row corresponds to one step and each column to one output field. A new file is created
for each track, with the label <code class="docutils literal notranslate"><span class="pre">Track#.txt</span></code> added to the configured output file name. This format is useful for
working with plotting tools such as <a class="reference external" href="http://www.gnuplot.info/">Gnuplot</a>, or for importing or comparing the output to other applications.</p>
<p>A typical output file looks like this:</p>
<div class="highlight- notranslate"><div class="highlight"><pre><span></span>step_id     continuous_time continuous_length       time    position_x      position_y      position_z
0   3.79467e-13     3.18284e-07     3.79467e-13     -0.000395068    -0.000194398    -0.0025
1   3.79467e-13     3.18288e-07     7.58933e-13     -0.000395383    -0.000194364    -0.0025
2   3.79467e-13     3.18292e-07     1.1384e-12      -0.000395686    -0.000194452    -0.0025
3   3.79467e-13     3.18297e-07     1.51787e-12     -0.000395933    -0.00019465     -0.0025
4   3.79467e-13     3.18301e-07     1.89733e-12     -0.000396085    -0.000194928    -0.0025
5   3.79467e-13     3.18305e-07     2.2768e-12      -0.000396119    -0.000195242    -0.0025
</pre></div>
</div>
<p>However, because the storage is rather inefficient it should not be used for large-scale simulations. File sizes on
the order of several Gigabytes can be easily produced by a typical Monte-Carlo simulation!</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="kgeobag_complex.html" class="btn btn-neutral float-left" title="Complex Shapes in KGeoBag" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools.html" class="btn btn-neutral float-right" title="Additional Simulation Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, The Kassiopeia developers..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>